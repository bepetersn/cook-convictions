{% extends '_base.html' %}

{% block css %}
  {{ super() }}
  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css">
  <link rel="stylesheet" type="text/css" href="css/convictions.css">
{% endblock css %}

{% block content %}

<div id="cover-page">
  <div class="bg-img"></div>
  <div class="bg-shade">
      <h1>{{ title }}</h1>
  </div>
  <div class="bg-clear"></div>
</div>

<div class="slides">
{% for section in sections %}
  <section id="{{ section.id }}">
  {% for slide in slides %}
  {% if slide.section_id == section.id %}
  <section id="{{ slide.id }}" class="{% if slide.class %}{{ slide.class }}{% endif %}">
    {{ render_file("slides/{0}.md".format(slide.id))|markdown }}
  </section>
  {% endif %}
  {% endfor %}
  </section>
{% endfor %}
</div>

{% endblock content %}

{% block library_scripts %}
{{ super() }}
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
{% endblock %}

{% block scripts %}
<script src="js/convictions.js"></script>
<script src="js/convictions-charts.js"></script>
<script>
$(function() {
  // Data and URLs to data
  var DATA_BASE_URL = 'data';
  var COMMUNITY_AREAS_URL = DATA_BASE_URL + '/community_areas.json';
  var CHICAGO_URL = DATA_BASE_URL + '/chicago.json';
  var SUBURBS_URL = DATA_BASE_URL + '/suburbs.json';
  var CONVICTIONS_BY_COMMUNITY_AREA_AGE_18_24_URL = DATA_BASE_URL + '/convictions_by_community_area_18_24.json';
  var CONVICTIONS_BY_AGE_URL = DATA_BASE_URL + '/convictions_by_age.json';

  var CONVICTIONS_BY_TYPE = [{"value": 4183, "label": "Violent Index Crimes"}, {"value": 10477, "label": "Property Index Crimes"}, {"value": 48002, "label": "Drug Crimes"}];
  var CONVICTIONS_BY_SEX_AGE_18_24 = {"uknwn_sex": 2, "female": 3809, "male": 39769};
  var CONVICTIONS_DRUG_BY_CLASS = [{"label": "Manufacture or Delivery", "felony_1": {"label": "Class 1 Felony", "value": 5744}, "unkwn_class": {"label": "Unknown Class", "value": 4530}, "felony_4": {"label": "Class 4 Felony", "value": 1762}, "misd_b": {"label": "Class B Misdemeanor", "value": 25}, "felony_2": {"label": "Class 2 Felony", "value": 853}, "misd_a": {"label": "Class A Misdemeanor", "value": 691}, "felony_x": {"label": "Class X Felony", "value": 34}, "felony_3": {"label": "Class 3 Felony", "value": 1223}}, {"label": "Possession", "no_class": {"label": "No Class", "value": 1}, "felony_2": {"label": "Class 2 Felony", "value": 40}, "misd_a": {"label": "Class A Misdemeanor", "value": 74}, "felony_x": {"label": "Class X Felony", "value": 0}, "misd_c": {"label": "Class C Misdemeanor", "value": 32}, "felony_1": {"label": "Class 1 Felony", "value": 554}, "unkwn_class": {"label": "Unknown Class", "value": 16}, "felony_4": {"label": "Class 4 Felony", "value": 32127}, "misd_b": {"label": "Class B Misdemeanor", "value": 112}, "felony_3": {"label": "Class 3 Felony", "value": 189}}]; 

  // Slugs for drug charge classes in above data, in order of
  // increasing severity
  var DRUG_CHARGE_CLASSES = [
    'unkwn_class',
    'no_class',
    'misd_c',
    'misd_b',
    'misd_a',
    'felony_4',
    'felony_3',
    'felony_2',
    'felony_1',
    'felony_x'
  ];

  var renderChart = Convictions.renderChart;

  Convictions.createChicagoMap('#your-city-map-container', COMMUNITY_AREAS_URL, SUBURBS_URL, CHICAGO_URL);

  renderChart('#charges-categories-chart', Convictions.createCategoryChart, 
    CONVICTIONS_BY_TYPE);

  renderChart('#drug-charges-class-chart', Convictions.createDrugChargeClassChart,
    CONVICTIONS_DRUG_BY_CLASS, DRUG_CHARGE_CLASSES, [
      '#66c2a5',
      '#fc8d62',
      '#8da0cb',
      '#e78ac3',
      '#a6d854',
      '#ffd92f',
      '#e5c494',
      '#b3b3b3'
  ]);


  $.getJSON(CONVICTIONS_BY_AGE_URL, function(data) {
    renderChart('#convictions-by-age-chart', Convictions.createAgeChart,
      data);
  });

  // Download the JSONified version of the tarbell context
  $.getJSON('/data.json', function(data) {
     var glossary = data.glossary;

     // Look for items with a 'data-term' attribute set and enable a
     // definition popover
     $('[data-term]').each(function() {
       var $el = $(this);
       var term = $el.data('term');
       var entry = glossary[term];

       $el.popover({
         content: entry.value,
         title: entry.label,
         trigger: 'click hover'
       });
     });
  })

  // Update the navigation highlighting as we scroll to 
  // various sections in the page
  $('body').scrollspy({target: '#top-nav'})
    .on('activate.bs.scrollspy', function (e) {
    // Set the correct hash based on the scroll position
    var $target = $(e.target);
    var $anchor = $target.find('a.slide-circle');

    // we only care about slides, not sections
    if ($anchor.length == 1) {
      var hash = $anchor.attr('href');

      // update the history object instead of the
      // location's hash, so we don't jump around
      // when we scroll backwards
      if(history.replaceState) {
          history.replaceState(null, null, hash);
      }
      else {
          location.hash = hash;
      }
    }
  });

});
</script>
{% endblock %}
